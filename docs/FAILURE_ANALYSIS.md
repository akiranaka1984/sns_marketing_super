# Instagram投稿失敗パターン分析レポート

## 概要

このレポートは、SNSマーケティング自動化システムにおけるInstagram投稿の失敗パターンを分析し、根本原因と解決策を提示します。

## データサマリー

### 失敗した投稿の統計

- **総失敗数**: 5件
- **共通エラー**: `VERIFICATION_FAILED`
- **影響を受けたアカウント**: 
  - アカウントID 330001: 4件
  - アカウントID 270002: 1件
- **失敗時期**: 2025-12-17 08:01:00 〜 2025-12-18 06:11:00

### 失敗した投稿の詳細

| 投稿ID | アカウントID | 実行日時 | エラーメッセージ | スクリーンショット |
|--------|------------|---------|-----------------|------------------|
| 90002 | 330001 | 2025-12-18 06:11:00 | VERIFICATION_FAILED | なし |
| 90003 | 330001 | 2025-12-18 06:11:00 | VERIFICATION_FAILED | なし |
| 90001 | 330001 | 2025-12-18 06:11:00 | VERIFICATION_FAILED | なし |
| 60004 | 330001 | 2025-12-17 08:14:00 | VERIFICATION_FAILED | なし |
| 60003 | 270002 | 2025-12-17 08:01:00 | VERIFICATION_FAILED | なし |

## 失敗パターンの分析

### パターン1: VERIFICATION_FAILED

#### 症状
- すべての失敗した投稿が`VERIFICATION_FAILED`エラーを返している
- スクリーンショットURLが`NULL`（スクリーンショットが撮影されていない）
- 投稿URLが`NULL`（投稿が完了していない）

#### 考えられる原因

1. **投稿処理自体が失敗している**
   - Instagramアプリが正しく起動しなかった
   - タップ座標がずれていて、ボタンを押せなかった
   - ネットワークエラーで投稿がアップロードされなかった

2. **検証プロセスが失敗している**
   - UI要素の検出に失敗した
   - スクリーンショットの撮影に失敗した
   - DuoPlus APIのタイムアウト

3. **デバイスの状態異常**
   - デバイスがオフラインになっている
   - Instagramアプリがクラッシュした
   - デバイスのストレージが不足している

#### 検証方法

1. **デバイスの状態確認**
   ```sql
   SELECT id, deviceId, status, lastLoginAt FROM accounts WHERE id IN (330001, 270002);
   ```

2. **ログの確認**
   ```sql
   SELECT * FROM logs WHERE scheduledPostId IN (90002, 90003, 90001, 60004, 60003) ORDER BY createdAt DESC;
   ```

3. **デバイスの画面確認**
   - DuoPlusの管理画面でデバイスの現在の画面を確認
   - デバイスがどの画面で止まっているかを特定

### パターン2: メディアがない投稿

#### 症状
- 投稿ID 60001が`NO_MEDIA_PROVIDED`エラーで失敗（既に削除済み）

#### 原因
- Instagramは画像または動画が必須だが、メディアURLが提供されていなかった

#### 解決策
- フロントエンドでメディアアップロードを必須にする（既に実装済み）

### パターン3: デバイスがメッセージ画面で止まる

#### 症状
- デバイスが「新規メッセージ」画面で停止し、Instagramアプリが開かない

#### 原因
- 前回の操作が完了せず、アプリが予期しない状態になっている
- ホーム画面に戻る処理が正しく実行されていない

#### 解決策
- ホーム画面に戻る処理を強化する
- アプリ起動前にデバイスの画面状態を確認する

## 根本原因の仮説

### 仮説1: DuoPlus APIのタイムアウト

**説明**: DuoPlus APIのリクエストがタイムアウトし、投稿処理が中断されている可能性があります。

**検証方法**:
- DuoPlus APIのレスポンス時間をログに記録する
- タイムアウト設定を確認する（現在のデフォルトは30秒）

**解決策**:
- タイムアウト時間を延長する
- リトライロジックを実装する

### 仮説2: タップ座標のずれ

**説明**: デバイスの解像度が想定と異なるため、タップ座標がずれてボタンを押せていない可能性があります。

**検証方法**:
- デバイスの解像度を確認する
  ```bash
  adb shell wm size
  ```
- スクリーンショットを撮影して、ボタンの実際の位置を確認する

**解決策**:
- デバイスの解像度を動的に取得し、座標を計算する
- UIAutomatorを使用してボタンの位置を動的に検出する

### 仮説3: Instagramアプリのログアウト

**説明**: Instagramアプリがログアウト状態になっており、投稿処理が失敗している可能性があります。

**検証方法**:
- デバイスの画面を確認し、ログイン画面が表示されているか確認する
- アカウントの`lastLoginAt`フィールドを確認する

**解決策**:
- 投稿前にログイン状態を確認する
- 必要に応じて自動的に再ログインする

### 仮説4: ネットワークエラー

**説明**: デバイスのネットワーク接続が不安定で、投稿のアップロードに失敗している可能性があります。

**検証方法**:
- デバイスのネットワーク状態を確認する
  ```bash
  adb shell dumpsys connectivity
  ```
- 投稿処理中のネットワークエラーをログに記録する

**解決策**:
- ネットワークエラー時にリトライする
- アップロード前にネットワーク接続を確認する

## 推奨される調査手順

### ステップ1: デバイスの状態確認

1. DuoPlusの管理画面でデバイス`s0t85`の状態を確認
2. デバイスがオンラインかどうかを確認
3. デバイスの現在の画面を確認（スクリーンショット撮影）

### ステップ2: ログの詳細確認

1. データベースの`logs`テーブルで失敗した投稿のログを確認
2. DuoPlus APIのレスポンスを確認
3. エラーメッセージの詳細を分析

### ステップ3: 手動テスト

1. DuoPlusの管理画面でデバイスを手動操作
2. Instagramアプリを開く
3. 手動で投稿を作成してみる
4. どのステップで失敗するかを特定

### ステップ4: コードの修正

1. 特定された問題に基づいてコードを修正
2. ローカル環境でテスト
3. 本番環境にデプロイ

### ステップ5: 再テスト

1. 新しい投稿を作成
2. 投稿処理を実行
3. 結果を確認

## 緊急対応策

### 対応策1: 手動投稿

**説明**: 自動投稿が失敗している間、手動で投稿を実行する

**手順**:
1. DuoPlusの管理画面でデバイスを操作
2. Instagramアプリを開く
3. 投稿内容をコピー&ペーストして手動で投稿

### 対応策2: 別のデバイスを使用

**説明**: 現在のデバイスに問題がある場合、別のデバイスで投稿を試す

**手順**:
1. 新しいデバイスをDuoPlusに登録
2. Instagramアカウントをログイン
3. 新しいデバイスで投稿を実行

### 対応策3: Instagram Graph API移行

**説明**: 長期的な解決策として、公式APIを使用する

**前提条件**:
- Instagramビジネスアカウントが必要
- Facebook Pageとの連携が必要

**メリット**:
- 安定性が高い
- 公式サポートがある
- タップ座標のずれなどの問題がない

**デメリット**:
- ビジネスアカウントのみ対応
- 個人アカウントでは使用できない

## 次のステップ

1. **デバイスの状態確認**: DuoPlusの管理画面でデバイス`s0t85`の状態を確認し、スクリーンショットを撮影
2. **ログの詳細確認**: データベースの`logs`テーブルで失敗した投稿のログを確認
3. **手動テスト**: デバイスを手動操作してInstagram投稿を試す
4. **コードの修正**: 特定された問題に基づいてコードを修正
5. **再テスト**: 新しい投稿を作成して投稿処理を実行

## 関連ドキュメント

- [Instagram投稿プロセスの技術ドキュメント](./INSTAGRAM_POSTING_PROCESS.md)
- [DuoPlus API仕様](./DUOPLUS_API_REFERENCE.md)

## 更新履歴

- 2025-12-18: 初版作成
