# SNSマーケティング自動化システム - アーキテクチャ整理

## 1. 現状の問題点

### 複雑すぎる学習システム
現在、学習データが3つのテーブルに分散しており、連携が不十分：

| テーブル | 用途 | 投稿生成での使用 |
|---------|------|-----------------|
| `agentKnowledge` | エージェント全体の学習 | ✅ 使用される |
| `accountLearnings` | アカウント固有の学習 | ✅ 使用される |
| `buzzLearnings` | バズ投稿の分析結果 | ❌ 使用されない |

**問題**: `buzzLearnings`は分析結果を保存するだけで、投稿生成に自動反映されない

---

## 2. 簡素化されたアーキテクチャ

### 統合された学習フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      学習ソース                                  │
├──────────────────┬──────────────────┬──────────────────────────┤
│ 自分の投稿実績   │ バズ投稿分析     │ モデルアカウント         │
│ (自動)           │ (手動分析)       │ (紐付け設定)             │
└────────┬─────────┴────────┬─────────┴────────────┬─────────────┘
         │                  │                       │
         │                  │ 自動変換              │ 自動適用
         ↓                  ↓                       ↓
┌─────────────────────────────────────────────────────────────────┐
│                   accountLearnings                              │
│              （統一された学習データストア）                       │
│  - posting_style: 投稿スタイル                                  │
│  - success_pattern: 成功パターン                                │
│  - hashtag_strategy: ハッシュタグ戦略                           │
│  - timing_pattern: 投稿タイミング                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 自動参照
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      投稿生成                                    │
│  agent-engine.ts → generateContent()                            │
│  ・アカウント固有のaccountLearningsを参照                        │
│  ・成功パターンに基づいたコンテンツ生成                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 主要コンポーネントの役割

### 3.1 バズ分析 (`buzz-analyzer.ts`)
**目的**: 外部のバズ投稿を分析してパターンを抽出

```
入力: バズ投稿のテキスト・エンゲージメント数
  ↓
分析: フック、CTA、構成、感情トリガー等を解析
  ↓
出力: buzzLearnings に保存
  ↓
変換: accountLearnings に自動変換 ← 【修正ポイント】
```

### 3.2 モデルアカウント連携 (`project-model-accounts.routers.ts`)
**目的**: インフルエンサーのパターンをプロジェクトに適用

```
設定: プロジェクト ←→ モデルアカウント紐付け
  ↓
トリガー: バズ分析でパターン抽出時
  ↓
適用: 紐付けアカウントのaccountLearningsに自動追加
```

### 3.3 投稿生成 (`agent-engine.ts`)
**目的**: AI を使って投稿コンテンツを生成

```
入力:
  - エージェント設定（テーマ、トーン）
  - accountLearnings（成功パターン、スタイル）
  - 最近の投稿（重複防止）
  ↓
生成: OpenAI API でコンテンツ作成
  ↓
出力: scheduledPosts に保存
```

### 3.4 投稿実行 (`scheduled-posts.ts`)
**目的**: 予約投稿を実際に公開

```
トリガー: 1分ごとのcron
  ↓
処理: 公開時刻が来た投稿を取得
  ↓
実行: DuoPlus API で投稿
  ↓
後処理: インタラクションタスク作成
```

### 3.5 パフォーマンス分析 (`agent-engine.ts`)
**目的**: 投稿結果から学習

```
トリガー: 投稿から24時間後
  ↓
分析: エンゲージメント率を計算
  ↓
学習:
  - 成功(70%↑): success_pattern として保存
  - 失敗(30%↓): failure_pattern として保存
  ↓
保存先: accountLearnings
```

---

## 4. データフロー図

```
                        ユーザー操作
                             │
            ┌────────────────┼────────────────┐
            │                │                │
            ↓                ↓                ↓
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │ プロジェクト  │ │ バズ分析ページ│ │ モデルアカウント│
    │ 管理          │ │               │ │ 設定          │
    └───────┬───────┘ └───────┬───────┘ └───────┬───────┘
            │                │                │
            │                │                │
            ↓                ↓                ↓
    ┌───────────────────────────────────────────────────┐
    │                   Backend API                      │
    │  projects.routers / buzz-analysis / model-accounts │
    └───────────────────────┬───────────────────────────┘
                            │
                            ↓
    ┌───────────────────────────────────────────────────┐
    │                  accountLearnings                  │
    │          （統合学習データベース）                   │
    └───────────────────────┬───────────────────────────┘
                            │
                            ↓
    ┌───────────────────────────────────────────────────┐
    │               agent-engine.ts                      │
    │           generateContent() で投稿生成             │
    └───────────────────────┬───────────────────────────┘
                            │
                            ↓
    ┌───────────────────────────────────────────────────┐
    │                scheduledPosts                      │
    │              予約投稿データ                        │
    └───────────────────────┬───────────────────────────┘
                            │
                            ↓
    ┌───────────────────────────────────────────────────┐
    │              scheduled-posts.ts                    │
    │          DuoPlus API で実際に投稿                  │
    └───────────────────────┬───────────────────────────┘
                            │
                            ↓
    ┌───────────────────────────────────────────────────┐
    │                 X (Twitter)                        │
    │              投稿が公開される                      │
    └───────────────────────────────────────────────────┘
```

---

## 5. 必要な修正

### 修正1: バズ分析の自動反映

**現状**: `extractPatterns` でパターン抽出 → `buzzLearnings` に保存で終わり

**修正後**: パターン抽出後に自動で `accountLearnings` に変換

```typescript
// buzz-analysis.routers.ts の extractPatterns 内
// パターン保存後に自動変換を追加
for (const learningId of savedLearnings) {
  await autoConvertBuzzLearningToAccountLearnings(learningId, ctx.user.id);
}
```

### 修正2: 学習の優先順位明確化

投稿生成時の学習参照優先順位：
1. アカウント固有の成功パターン（最優先）
2. バズ分析から変換されたパターン
3. エージェント全体のパターン（補助的）

---

## 6. 簡素化のポイント

### Before（複雑）
- 3つの学習テーブル（agentKnowledge, accountLearnings, buzzLearnings）
- 手動で学習を適用する必要あり
- 連携が不明確

### After（簡素化）
- `accountLearnings` を中心とした統一ストア
- バズ分析は自動で accountLearnings に変換
- モデルアカウント連携も自動で accountLearnings に適用
- 投稿生成は accountLearnings のみ参照

---

## 7. ユーザー向けの機能説明

### バズ分析ページ
1. **投稿追加**: バズった投稿を登録
2. **分析実行**: AIが成功要因を分析
3. **パターン抽出**: 複数投稿から共通パターンを発見
4. **自動適用**: 抽出パターンは自動でアカウントに反映

### モデルアカウント連携
1. **モデル登録**: 参考にしたいアカウントを追加
2. **プロジェクト紐付け**: どのプロジェクトで使うか設定
3. **自動適用ON**: パターン抽出時に自動反映
4. **対象アカウント選択**: どのアカウントに適用するか

### 投稿の自動生成
1. エージェントが accountLearnings を参照
2. 成功パターンに基づいてコンテンツ生成
3. 過去投稿との重複を避ける
4. 予約時刻に自動投稿
