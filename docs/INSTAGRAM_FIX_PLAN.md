# InstagramæŠ•ç¨¿å¤±æ•—ã®ä¿®æ­£è¨ˆç”»

## æ¤œè¨¼çµæœã«åŸºã¥ãå•é¡Œç‚¹

### ğŸ”´ å„ªå…ˆåº¦1: ãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ï¼ˆç¢ºå®šï¼‰

**å•é¡Œ**: ã™ã¹ã¦ã®å¤±æ•—ã—ãŸæŠ•ç¨¿ã§`mediaUrls`ãŒ`NULL`

**å½±éŸ¿**: Instagramã¯ç”»åƒã¾ãŸã¯å‹•ç”»ãŒå¿…é ˆã ãŒã€æŠ•ç¨¿ä½œæˆæ™‚ã«ãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸ

**ä¿®æ­£å†…å®¹**:
1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æŠ•ç¨¿ä½œæˆæ™‚ã«InstagramæŠ•ç¨¿ã«ã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å¿…é ˆã«ã™ã‚‹
2. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: InstagramæŠ•ç¨¿ã®æ¤œè¨¼ã‚’å¼·åŒ–ï¼ˆmediaUrlsãŒç©ºã®å ´åˆã¯æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼‰
3. **UIæ”¹å–„**: ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ 

### ğŸŸ¡ å„ªå…ˆåº¦2: ã‚¿ãƒƒãƒ—åº§æ¨™ãŒè§£åƒåº¦ã«ä¾å­˜ã—ã¦ã„ã‚‹

**å•é¡Œ**: å›ºå®šåº§æ¨™ï¼ˆ1080x2400æƒ³å®šï¼‰ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ‡ãƒã‚¤ã‚¹ã®å®Ÿéš›ã®è§£åƒåº¦ã¨ç•°ãªã‚‹å ´åˆã«å¤±æ•—ã™ã‚‹

**ä¿®æ­£å†…å®¹**:
1. **å‹•çš„åº§æ¨™è¨ˆç®—**: ãƒ‡ãƒã‚¤ã‚¹ã®è§£åƒåº¦ã‚’å–å¾—ã—ã€åº§æ¨™ã‚’å‹•çš„ã«è¨ˆç®—
2. **åº§æ¨™ã®æ­£è¦åŒ–**: ç›¸å¯¾åº§æ¨™ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰ã‚’ä½¿ç”¨

### ğŸŸ¡ å„ªå…ˆåº¦3: ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ¥ã®ç”»é¢ã§æ­¢ã¾ã£ã¦ã„ã‚‹

**å•é¡Œ**: ãƒ‡ãƒã‚¤ã‚¹ãŒäºˆæœŸã—ãªã„ç”»é¢ã§åœæ­¢ã—ã¦ã„ã‚‹å¯èƒ½æ€§

**ä¿®æ­£å†…å®¹**:
1. **ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®å¼·åˆ¶å¾©å¸°**: æŠ•ç¨¿å‰ã«å¿…ãšãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
2. **ç”»é¢çŠ¶æ…‹ã®ç¢ºèª**: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦ç¾åœ¨ã®ç”»é¢ã‚’ç¢ºèª

### ğŸŸ¢ å„ªå…ˆåº¦4: Instagramã‚¢ãƒ—ãƒªãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹

**å•é¡Œ**: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§

**ä¿®æ­£å†…å®¹**:
1. **ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª**: æŠ•ç¨¿å‰ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
2. **è‡ªå‹•å†ãƒ­ã‚°ã‚¤ãƒ³**: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«å†ãƒ­ã‚°ã‚¤ãƒ³

### ğŸŸ¢ å„ªå…ˆåº¦5: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼

**å•é¡Œ**: æŠ•ç¨¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§

**ä¿®æ­£å†…å®¹**:
1. **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ï¼‰
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: é©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

---

## å®Ÿè£…è¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º1: å³åº§ã«å®Ÿæ–½ï¼ˆå„ªå…ˆåº¦1ï¼‰

#### 1.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `client/src/pages/ScheduledPosts.tsx`

**ä¿®æ­£å†…å®¹**:
- InstagramæŠ•ç¨¿ä½œæˆæ™‚ã«ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å¿…é ˆã«ã™ã‚‹
- ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ 
- ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ 

**æ¤œè¨¼**:
```typescript
// InstagramæŠ•ç¨¿ã®å ´åˆã€mediaUrlsãŒå¿…é ˆ
if (platform === 'instagram' && (!mediaUrls || mediaUrls.length === 0)) {
  toast.error('Instagram requires at least one image or video');
  return;
}
```

#### 1.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `server/sns-posting.ts`

**ä¿®æ­£å†…å®¹**:
- `postToInstagram`é–¢æ•°ã®æ¤œè¨¼ã‚’å¼·åŒ–
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„
- ãƒ­ã‚°å‡ºåŠ›ã‚’è¿½åŠ 

**å®Ÿè£…**:
```typescript
// æ—¢å­˜ã®æ¤œè¨¼ã‚’ç¶­æŒ
if (!mediaUrls || mediaUrls.length === 0) {
  console.error(`[SNSPosting] Instagram post failed: NO_MEDIA_PROVIDED`);
  return {
    success: false,
    message: 'Instagram requires image/video content. Please provide a media URL.',
    error: 'NO_MEDIA_PROVIDED',
  };
}

// è¿½åŠ ã®æ¤œè¨¼: mediaUrlsãŒç©ºé…åˆ—ã§ãªã„ã“ã¨ã‚’ç¢ºèª
if (Array.isArray(mediaUrls) && mediaUrls.every(url => !url || url.trim() === '')) {
  console.error(`[SNSPosting] Instagram post failed: INVALID_MEDIA_URLS`);
  return {
    success: false,
    message: 'Instagram requires valid media URLs. All URLs are empty.',
    error: 'INVALID_MEDIA_URLS',
  };
}
```

### ãƒ•ã‚§ãƒ¼ã‚º2: çŸ­æœŸæ”¹å–„ï¼ˆå„ªå…ˆåº¦2ï¼‰

#### 2.1 å‹•çš„åº§æ¨™è¨ˆç®—ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `server/sns-posting.ts`

**ä¿®æ­£å†…å®¹**:
- ãƒ‡ãƒã‚¤ã‚¹ã®è§£åƒåº¦ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
- åº§æ¨™ã‚’å‹•çš„ã«è¨ˆç®—ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
- ã™ã¹ã¦ã®ã‚¿ãƒƒãƒ—åº§æ¨™ã‚’å‹•çš„è¨ˆç®—ã«å¤‰æ›´

**å®Ÿè£…**:
```typescript
/**
 * Get device resolution
 */
async function getDeviceResolution(apiKey: string, deviceId: string): Promise<{ width: number; height: number }> {
  try {
    const result = await executeAdbCommand(apiKey, deviceId, 'wm size');
    // Parse output: "Physical size: 1080x2400"
    const match = result.output?.match(/(\d+)x(\d+)/);
    if (match) {
      return { width: parseInt(match[1]), height: parseInt(match[2]) };
    }
  } catch (error) {
    console.error('[SNSPosting] Failed to get device resolution:', error);
  }
  // Default to 1080x2400
  return { width: 1080, height: 2400 };
}

/**
 * Calculate tap coordinates based on device resolution
 */
function calculateCoordinates(
  baseWidth: number,
  baseHeight: number,
  targetWidth: number,
  targetHeight: number,
  x: number,
  y: number
): { x: number; y: number } {
  return {
    x: Math.round((x / baseWidth) * targetWidth),
    y: Math.round((y / baseHeight) * targetHeight),
  };
}

// ä½¿ç”¨ä¾‹
const resolution = await getDeviceResolution(apiKey, deviceId);
const createButton = calculateCoordinates(1080, 2400, resolution.width, resolution.height, 540, 1850);
await executeAdbCommand(apiKey, deviceId, `input tap ${createButton.x} ${createButton.y}`);
```

### ãƒ•ã‚§ãƒ¼ã‚º3: ä¸­æœŸæ”¹å–„ï¼ˆå„ªå…ˆåº¦3-5ï¼‰

#### 3.1 ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®å¼·åˆ¶å¾©å¸°

**å®Ÿè£…**:
```typescript
// æŠ•ç¨¿å‰ã«å¿…ãšãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
await executeAdbCommand(apiKey, deviceId, 'input keyevent KEYCODE_HOME');
await sleep(2000);

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¦ç¢ºèª
const homeScreenshot = await takeScreenshot(apiKey, deviceId, 'home_screen');
```

#### 3.2 ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª

**å®Ÿè£…**:
```typescript
// Instagramã‚¢ãƒ—ãƒªã‚’èµ·å‹•
await executeAdbCommand(apiKey, deviceId, 'monkey -p com.instagram.android -c android.intent.category.LAUNCHER 1');
await sleep(5000);

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
const screenshot = await takeScreenshot(apiKey, deviceId, 'after_launch');

// ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã©ã†ã‹ã‚’ç¢ºèªï¼ˆOCRã¾ãŸã¯ç”»åƒèªè­˜ï¼‰
// ç°¡æ˜“çš„ãªå®Ÿè£…: ç‰¹å®šã®åº§æ¨™ã®è‰²ã‚’ç¢ºèª
```

#### 3.3 ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

**å®Ÿè£…**:
```typescript
async function postToInstagramWithRetry(
  deviceId: string,
  content: string,
  mediaUrls?: string[],
  maxRetries: number = 3
): Promise<PostResult> {
  let lastError: string | undefined;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    console.log(`[SNSPosting] Instagram post attempt ${attempt}/${maxRetries}`);
    
    const result = await postToInstagram(deviceId, content, mediaUrls);
    
    if (result.success) {
      return result;
    }
    
    lastError = result.error;
    
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ãƒªãƒˆãƒ©ã‚¤
    if (result.error === 'NETWORK_ERROR' && attempt < maxRetries) {
      console.log(`[SNSPosting] Retrying in 5 seconds...`);
      await sleep(5000);
      continue;
    }
    
    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
    return result;
  }
  
  return {
    success: false,
    message: `Failed after ${maxRetries} attempts`,
    error: lastError,
  };
}
```

---

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] `postToInstagram`é–¢æ•°ã®mediaUrlsæ¤œè¨¼ãƒ†ã‚¹ãƒˆ
- [ ] å‹•çš„åº§æ¨™è¨ˆç®—é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
- [ ] ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

- [ ] ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã§å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºèª
- [ ] å®Ÿéš›ã®ãƒ‡ãƒã‚¤ã‚¹ã§æŠ•ç¨¿ãƒ†ã‚¹ãƒˆ
- [ ] è¤‡æ•°ã®è§£åƒåº¦ã§ãƒ†ã‚¹ãƒˆ

### 3. ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æŠ•ç¨¿ä½œæˆã‹ã‚‰InstagramæŠ•ç¨¿ã¾ã§
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
- [ ] ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ä¿å­˜ç¢ºèª

---

## å®Ÿè£…å„ªå…ˆé †ä½

1. **å³åº§ã«å®Ÿæ–½**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®mediaUrlsæ¤œè¨¼å¼·åŒ–ï¼ˆ30åˆ†ï¼‰
2. **çŸ­æœŸæ”¹å–„**: å‹•çš„åº§æ¨™è¨ˆç®—ã®å®Ÿè£…ï¼ˆ1æ™‚é–“ï¼‰
3. **ä¸­æœŸæ”¹å–„**: ãƒ›ãƒ¼ãƒ ç”»é¢å¾©å¸°ã€ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªã€ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ2æ™‚é–“ï¼‰

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### å„ªå…ˆåº¦1ã®ä¿®æ­£å¾Œ

- InstagramæŠ•ç¨¿æ™‚ã«ãƒ¡ãƒ‡ã‚£ã‚¢ãŒå¿…é ˆã«ãªã‚Šã€`NO_MEDIA_PROVIDED`ã‚¨ãƒ©ãƒ¼ãŒé˜²æ­¢ã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹UIãŒæä¾›ã•ã‚Œã‚‹

### å„ªå…ˆåº¦2ã®ä¿®æ­£å¾Œ

- ãƒ‡ãƒã‚¤ã‚¹ã®è§£åƒåº¦ã«ä¾å­˜ã›ãšã€æ­£ã—ã„åº§æ¨™ã§ã‚¿ãƒƒãƒ—ã§ãã‚‹
- ç•°ãªã‚‹è§£åƒåº¦ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚æŠ•ç¨¿ãŒæˆåŠŸã™ã‚‹

### å„ªå…ˆåº¦3-5ã®ä¿®æ­£å¾Œ

- ãƒ‡ãƒã‚¤ã‚¹ãŒäºˆæœŸã—ãªã„ç”»é¢ã§åœæ­¢ã—ã¦ã„ã¦ã‚‚ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«å¾©å¸°ã§ãã‚‹
- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ã‚‚è‡ªå‹•çš„ã«å†ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•çš„ã«ãƒªãƒˆãƒ©ã‚¤ã•ã‚Œã‚‹

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ](./VERIFICATION_REPORT.md)
- [InstagramæŠ•ç¨¿ãƒ—ãƒ­ã‚»ã‚¹ã®æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](./INSTAGRAM_POSTING_PROCESS.md)
- [å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æãƒ¬ãƒãƒ¼ãƒˆ](./FAILURE_ANALYSIS.md)
