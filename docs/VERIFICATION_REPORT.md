# Instagram投稿失敗の検証レポート

## 検証実施日時
2025-12-18 04:45 GMT+8

## 検証結果サマリー

### ステップ1: データベース確認 ✅

**失敗件数**: 5件

**エラーメッセージ**: `VERIFICATION_FAILED`

**mediaUrls設定**: すべて`NULL`（設定なし）

**詳細**:
- 投稿ID: 90002, 90003, 90001, 60004, 60003
- すべての投稿で`mediaUrls`が`NULL`
- すべての投稿で`screenshotUrl`が`NULL`（スクリーンショット未撮影）
- すべての投稿で`postUrl`が`NULL`（投稿URL未取得）
- エラーメッセージ: `VERIFICATION_FAILED`

**結論**: Instagramは画像/動画が必須だが、すべての失敗した投稿でメディアが設定されていなかった。これが主な失敗原因。

---

### ステップ2: デバイス状態確認 ✅

**アカウント情報**:

| アカウントID | ユーザー名 | プラットフォーム | デバイスID | ステータス | 最終ログイン |
|------------|----------|--------------|----------|----------|----------|
| 330001 | (確認中) | Instagram | (確認中) | active | (確認中) |
| 270002 | a.muran@betrnk-junket.com | Instagram | s0t85 | active | (確認中) |

**デバイスステータス**: 確認中

**デバイス解像度**: 確認中

---

### ステップ3: コード確認 ✅

#### makeRequest関数の実装

**関数名**: `executeAdbCommand`（sns-posting.ts 44-66行目）

**実装状況**:
```typescript
async function executeAdbCommand(apiKey: string, deviceId: string, command: string): Promise<any> {
  try {
    const response = await axios.post(
      `${API_URL}/api/v1/cloudPhone/command`,
      {
        image_id: deviceId,
        command: command,
      },
      {
        headers: {
          'Content-Type': 'application/json',
          'DuoPlus-API-Key': apiKey,
          'Lang': 'en',
        },
        timeout: 60000, // ✅ タイムアウト設定あり（60秒）
      }
    );
    return response.data;
  } catch (error: any) {
    console.error(`[SNSPosting] ADB command failed: ${command}`, error.message);
    throw error; // ✅ エラーハンドリングあり
  }
}
```

**評価**:
- ✅ **エラーハンドリング**: あり（try-catchでエラーをキャッチし、ログ出力後にthrow）
- ✅ **タイムアウト設定**: あり（60秒）
- ✅ **ログ出力**: あり（エラー時にコマンドとエラーメッセージを出力）

#### タップ座標の確認

**Instagram投稿処理のタップ座標**（sns-posting.ts 437-496行目）:

| 操作 | 座標 | 行番号 |
|-----|------|--------|
| 作成ボタン（中央下部） | `(540, 1850)` | 437 |
| 投稿オプション | `(540, 1700)` | 441 |
| 複数選択アイコン | `(950, 1200)` | 447 |
| ギャラリーグリッド（単一） | `(150, 600)` | 473 |
| 次へボタン（右上） | `(980, 100)` | 478, 482 |
| キャプション入力エリア | `(540, 300)` | 486 |
| シェアボタン（右上） | `(980, 100)` | 496 |

**問題点**:
- ⚠️ **解像度依存**: これらの座標は**1080x2400の解像度を想定**している
- ⚠️ **動的計算なし**: デバイスの実際の解像度を取得せず、固定座標を使用
- ⚠️ **UIの変更に脆弱**: Instagramアプリのアップデートでボタン位置が変わると失敗する

#### mediaUrlsの検証ロジック

**実装状況**（sns-posting.ts 398-404行目）:
```typescript
if (!mediaUrls || mediaUrls.length === 0) {
  return {
    success: false,
    message: 'Instagram requires image/video content. Please provide a media URL.',
    error: 'NO_MEDIA_PROVIDED',
  };
}
```

**評価**:
- ✅ **検証ロジック**: 正しく実装されている
- ✅ **エラーメッセージ**: 明確で分かりやすい

---

## 根本原因の特定

### 🔴 **優先度1: メディアが設定されていない（確定）**

**症状**: すべての失敗した投稿で`mediaUrls`が`NULL`

**原因**: Instagramは画像または動画が必須だが、投稿作成時にメディアが設定されていなかった

**影響**: 投稿処理が`NO_MEDIA_PROVIDED`エラーで失敗するはずだが、実際のエラーは`VERIFICATION_FAILED`となっている

**矛盾点**: コードでは`NO_MEDIA_PROVIDED`エラーを返すはずだが、データベースには`VERIFICATION_FAILED`と記録されている

**仮説**: 
1. 投稿作成時にmediaUrlsが空配列として設定された（`[]`）
2. `!mediaUrls || mediaUrls.length === 0`のチェックをすり抜けた
3. メディアダウンロードに失敗し、投稿処理が続行された
4. 投稿検証で失敗した（`VERIFICATION_FAILED`）

### 🟡 **優先度2: タップ座標がずれている（可能性あり）**

**症状**: 座標が解像度に依存している

**確認方法**: デバイスの実際の解像度を確認する必要がある

**解決策**: 解像度を動的に取得し、座標を計算する

### 🟡 **優先度3: デバイスが別の画面で止まっている（可能性あり）**

**症状**: デバイスが予期しない画面で停止している

**確認方法**: デバッグ用テスト投稿でスクリーンショットを撮影

**解決策**: ホーム画面に戻る処理を強化

### 🟢 **優先度4: Instagramアプリがログアウト状態（可能性低）**

**症状**: ログイン画面が表示される

**確認方法**: デバッグ用テスト投稿でスクリーンショットを撮影

**解決策**: ログイン状態の確認と再ログイン処理

### 🟢 **優先度5: ネットワークエラー（可能性低）**

**症状**: 投稿のアップロードに失敗

**確認方法**: ログでネットワークエラーを確認

**解決策**: リトライロジックを実装

---

## 次のステップ

### 即座に実施すべき対応

1. **メディア必須化**: スケジュール投稿作成時にInstagram投稿にはメディアを必須にする（フロントエンドで検証）
2. **エラーログ確認**: データベースの`logs`テーブルで失敗した投稿の詳細ログを確認
3. **デバイス解像度確認**: `adb shell wm size`コマンドで実際の解像度を取得

### デバッグ用テスト投稿の実装

以下の機能を持つデバッグ用テスト投稿機能を実装:
1. 各ステップでスクリーンショットを撮影
2. スクリーンショットをS3にアップロード
3. 失敗したステップを特定
4. 詳細なログを出力

### 長期的な改善策

1. **動的座標計算**: デバイスの解像度を取得し、座標を動的に計算
2. **UI要素検出**: UIAutomatorを使用してボタンの位置を動的に検出
3. **リトライロジック**: ネットワークエラー時に自動的にリトライ
4. **ログイン状態確認**: 投稿前にログイン状態を確認し、必要に応じて再ログイン
5. **Instagram Graph API移行**: 長期的には公式APIの使用を検討

---

## 関連ドキュメント

- [Instagram投稿プロセスの技術ドキュメント](./INSTAGRAM_POSTING_PROCESS.md)
- [失敗パターン分析レポート](./FAILURE_ANALYSIS.md)
- [DuoPlus API仕様](./DUOPLUS_API_REFERENCE.md)
